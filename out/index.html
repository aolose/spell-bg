<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Spells</title>
    <script src="./spells.js"></script>
    <script src="./icons.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, PingFang SC, Helvetica Neue, STHeiti, Microsoft Yahei, Tahoma, Simsun, sans-serif
        }

        #v1, #v2 {
            width: 30px
        }

        * {
            font-size: 13px;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background: none
        }

        .r {
            min-width: 980px;
            position: absolute;
            overflow: hidden;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
            background: #171829;
            color: #aaa
        }

        #c, .f, .c, .g {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center
        }

        #a {
            padding: 20px;
            margin-right: 10px;
            overflow: auto;
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            height: 100%
        }

        *::-webkit-scrollbar {
            width: 8px;
            height: 8px
        }

        *::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, .05)
        }

        *::-webkit-scrollbar-thumb {
            background-color: #1c93ff
        }

        #c div:hover, .act {
            color: Orange
        }

        #c div {
            padding: 10px;
            cursor: pointer
        }

        #c {
            -ms-flex-wrap: wrap;
            flex-wrap: wrap
        }

        ul {
            display: block;
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1
        }

        #b li {
            list-style: none;
            font-size: 12px
        }

        #b > div {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            color: #fff;
            padding: 3px 5px;
            border: 1px solid #07457b
        }

        #b * {
            white-space: normal;
            word-break: break-all
        }

        #b label {
            padding: 0 10px;
            width: 120px;
            color: darkorange
        }

        #b {
            height: 100%;
            padding: 10px 0 30px;
            line-height: 2;
            overflow: auto;
            width: 500px;
            background: #161d2f
        }

        .p {
            width: 100%;
            padding: 0 30px;
            background: #161d2f;
            min-height: 50px;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex
        }

        .g {
            height: 0;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            position: relative
        }

        .c * {
            white-space: normal;
            word-break: break-all
        }

        .c label {
            min-height: 40px;
            display: block;
            word-break: break-all;
            width: 200px;
            color: greenyellow
        }

        .c div {
            margin-left: 30px;
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            height: 100%
        }

        .c:hover {
            background: #1e2740
        }

        .lv {
            position: absolute;
            right: 10px;
            top: 5px;
            color: #64aef1
        }

        .tp {
            left: 10px;
            bottom: 10px;
            position: absolute;
            font-size: 12px;
            color: #fff
        }

        .c li {
            line-height: 1.5;
            font-size: 12px;
            color: #0cf
        }

        .c {
            position: relative;
            cursor: pointer;
            -webkit-box-align: start;
            align-items: flex-start;
            width: 400px;
            border: 3px solid #153049;
            margin: 3px;
            height: 160px;
            padding: 10px;
            background: #161d2f;
            float: left
        }

        .c i {
            border: 1px solid #404040;
            border-radius: 3px;
            display: block;
            width: 64px;
            height: 64px;
            margin-right: 10px;
            background: rgba(255, 87, 34, .04) url(./Icons_Skills.png)
        }

        input:focus {
            border-color: #1c93ff
        }

        input {
            width: 100px;
            padding: 0 5px;
            color: #fff;
            border: 0;
            outline: none;
            border-bottom: 1px solid rgba(255, 255, 255, .5);
            margin-right: 20px
        }

        .f label {
            white-space: nowrap
        }

        .f {
            -webkit-box-flex: 1;
            -ms-flex: 1;
            flex: 1;
            -webkit-box-pack: end;
            -ms-flex-pack: end;
            justify-content: flex-end;
            padding: 0 30px
        }
    </style>
</head>
<body>
<div class="r">
    <div class="p">
        <div id="c">
        </div>
        <div class="f">
            <div class="v">
                <label>Spell Name</label>
                <input id="v0"/>
            </div>
            <div class="v">
                <label>Level</label>
                <input id="v2"/>
            </div>
            <div class="v">
                <label>Min Damage</label>
                <input id="v1"/>
            </div>
        </div>
    </div>
    <div class="g">
        <div id="a">

        </div>
        <div id="b">

        </div>
    </div>
</div>
<script>
    const ft = {};
    const a = document.getElementById("a");
    const b = document.getElementById("b");
    const c = document.getElementById("c");
    const {spells, types} = data;

    function ps(o) {
        const v = Object.keys(o);
        let c = "";
        v.forEach((k) => {
            const d = o[k];
            let s = "";

            if (Array.isArray(d)) {
                const ss = d.map((u) => `<li>${u}</li>`).join("");
                s = `<ul>${ss}</ul>`;
            } else s = `<span>${d}</span>`;

            c += `<div>
<label>${k}</label>${s}
</div>`;
        });
        return c;
    }

    function ico(k) {
        const o = icons[k];

        if (o) {
            const {U1, U2, V1, V2} = o;
            return `background-position:-${U1}px -${V1}px`;
        }

        return "background-image:none";
    }

    const el = (t) => {
        const e = document.createElement("div");
        e.innerHTML = t;
        return e.children[0];
    };

    const card = (o) => {
        const {Name, SpellType, SpellProperties = [], Icon, Level} = o;
        const v = el(`
<div class="c">
   <i style="${ico(Icon)}" title="${Icon}"></i>
   <span class="lv">Level ${Level || "-"}</span>
   <span class="tp">${SpellType}</span>
   <div>
   <label>${Name.replace(SpellType + "_", "")
            .replace(/_/g, " ")
            .replace(/([a-z0-9])([A-Z])/g, "$1 $2")}</label>
   <ul>${SpellProperties.map((p) => "<li>" + p + "</li>").join("")}</ul>
    </div>
</div>
           `);
        v.d = o;

        v.filter = (t, k, g, l) => {
            let a = 0;
            const s = SpellType.toLowerCase();

            const f = (k, va, r = "") => {
                if (k) {
                    if (typeof va === "string") {
                        const v0 = va.toLowerCase().replace(s, "");
                        if (v0.indexOf(k.toLowerCase().replace(s, "")) === -1) a = 1;
                    } else {
                        if (+k !== va) a = 1;
                    }
                }
            };

            f(k, Name, SpellType);
            f(l, Level);
            f(t, SpellType);

            if (g && !isNaN(+g)) {
                let n = 0;
                SpellProperties.forEach((v) => {
                    const r = /DealDamage\((\d+)d(\d+),.*?\)/;
                    const [, a, b] = r.exec(v) || [];

                    if (b) {
                        if (a * b >= +g) n = 1;
                    }
                });
                if (!n) a = 1;
            }

            v.style.display = ["", "none"][a];
        };

        v.onclick = () => {
            b.innerHTML = ps(o);
        };

        return v;
    };

    const x = (id, key) => {
        const v = document.getElementById(id);

        v.oninput = v.onchange = v.onpaste = v.onblur = function () {
            ft[key] = v.value.replace(/^\s+|\s+$/, "");
            filter();
        };
    };

    const cds = [];
    Object.values(spells)
        .sort((a, b) => {
            const v = a.Name.replace(a.SpellType, "") > b.Name.replace(b.SpellType, "");
            return v ? 1 : -1;
        })
        .forEach((o) => cds.push(a.appendChild(card(o))));
    const tbs = [];

    function filter() {
        const {t, k, g, l} = ft;
        cds.forEach((c) => c.filter(t, k, g, l));
    }

    const cg = (k, t) => {
        ft.t = t;
        tbs.forEach((t) => t.act(k));
        filter();
    };

    [""].concat(Object.keys(types)).forEach((t) => {
        const n = t || "ALL";
        const b = el(`<div>${n.toUpperCase()}</div>`);

        b.onclick = () => {
            cg(n, t);
        };

        b.act = (k) => {
            b.className = k === n ? "act" : "";
        };

        tbs.push(b);
        c.appendChild(b);
    });
    x("v0", "k");
    x("v1", "g");
    x("v2", "l");
    cg("ALL", "");

</script>
</body>
</html>
